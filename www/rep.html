<!DOCTYPE html>
<html lang="en">
  
  <head>
  <meta http-equiv="Content-Type" content="text/html; charset=UTF-8"/>
  <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1.0"/>
  <title>Wash4All</title>

  <!--  Scripts-->
  <script src="js/jquery-2.1.1.min.js"></script>
  <script src="js/materialize.js"></script>
  <script src="js/init.js"></script>
  <!--D3 -->
  <script src="js/d3.v3.min.js" charset="utf-8"></script>
  <!-- Custom Scripts -->
  <script src="js/db.js"></script>
  <script src="js/table.js"></script>

  <!-- CSS  -->
  <link href="https://fonts.googleapis.com/icon?family=Material+Icons" rel="stylesheet">
  <link href="css/materialize.css" type="text/css" rel="stylesheet" media="screen,projection"/>
  <link href="css/style.css" type="text/css" rel="stylesheet" media="screen,projection"/>
  <link href="css/viz.css" type="text/css" rel="stylesheet" media="screen,projection"/>
  <link href="https://fonts.googleapis.com/icon?family=Material+Icons"
      rel="stylesheet">

</head>

<body>
  <nav class="light-blue lighten-1" role="navigation">
    <a href="#" data-activates="nav-mobile" class="button-collapse"><img src="./img/ic_dehaze_2x.png" style="padding:5px;" alt="menu"/></a>
    <div class="nav-wrapper container"><a id="logo-container" href="./index.html" class="brand-logo" style="padding-left:30px;">OpenSourceWater</a>
      <ul class="right hide-on-med-and-down">
        <li><a href="./index.html">Gráficos</a></li>
        <li><a href="./table.html">Tablas</a></li>
        <li><a href="./settings.html">Ajustes</a></li>
        <li class="active"><a href="./rep.html">Informes</a></li>
      </ul>

      <ul id="nav-mobile" class="side-nav">
        <li><a href="./index.html">Gráficos</a></li>
        <li><a href="./table.html">Tablas</a></li>
        <li><a href="./settings.html">Ajustes</a></li>
        <li class="active"><a href="./rep.html">Informes</a></li>
      </ul>
    </div>
  </nav>
  <div class="section no-pad-bot" id="index-banner">
    <div class="container">
      <br><br>
      <!--<h1 class="header center orange-text">Wash4All</h1>-->
      <div class="row center">
        <h4 id="datosHeader"></h4>
        <script>
        var pname = getPlantName();
        if(pname != null){$("#datosHeader").html("Datos Sobre la Planta de "+pname);}
        else{$("#datosHeader").html("Datos Sobre la Planta");}
        
        </script>
        <h5 class="header col s12 light">Explora los informes mensuales de la planta.</h5>
        
      </div>
      <div id="headerContent">
      </div>
      <div class="container">
        <div class="row center"> 
        </div>
      </div>       
    </div>
    <script type="text/javascript">

      var plantName = {
        "aga":"Agalteca",
        "ala":"Alauca",
        "ati":"Atima",
        "ccom":"Cuatro Comunidades" ,
        "doto":"Otoro",
        "mar1":"Marcala",
        "moro":"Moroceli",
        "smat":"San Matias",
        "snic":"San Nicolas",
        "tam":"Tamara"
      }

      var monthName = ["enero", "enero", "feb", "mar", "abr", "mayo", "junio", "julio", "ago", "sep", "oct", "nov", "dic"]
      var monthFullName = {"enero":"Enero", 
        "feb":"Febrero", 
        "mar":"Marzo", 
        "abr":"Abril", 
        "mayo":"Mayo", 
        "junio":"Junio", 
        "julio":"Julio", 
        "ago":"Agosto", 
        "sep":"Septiembre", 
        "oct":"Octubre", 
        "nov":"Noviembre", 
        "dic":"Diciembre"
      }

      // Your Client ID can be retrieved from your project in the Google
      // Developer Console, https://console.developers.google.com
      var CLIENT_ID = '308933317598-eea7d04ho9bgvtq62bp7d1qbkm4k6m6a.apps.googleusercontent.com';

      var SCOPES = ['https://www.googleapis.com/auth/drive', 'https://www.googleapis.com/auth/userinfo.email'];

      /**
       * Check if current user has authorized this application.
       */
      function checkAuth() {
        gapi.auth.authorize(
          {
            'client_id': CLIENT_ID,
            'scope': SCOPES.join(' '),
            'immediate': true
          }, handleAuthResult);
      }

      /**
       * Handle response from authorization server.
       *
       * @param {Object} authResult Authorization result.
       */
      function handleAuthResult(authResult) {
        var authorizeDiv = document.getElementById('authorize-div');
        if (authResult && !authResult.error) {
          // Hide auth UI, then load client library.
          authorizeDiv.style.display = 'none';
          callScriptFunction();
        } else {
          // Show auth UI, allowing the user to initiate authorization by
          // clicking authorize button.
          authorizeDiv.style.display = 'inline';
        }
      }

      /**
       * Initiate auth flow in response to user clicking authorize button.
       *
       * @param {Event} event Button click event.
       */
      function handleAuthClick(event) {
        gapi.auth.authorize(
          {client_id: CLIENT_ID, scope: SCOPES, immediate: false},
          handleAuthResult);
        return false;
      }

      /**
       * Calls an Apps Script function to list the folders in the user's
       * root Drive folder.
       */
      function callScriptFunction() {
        var scriptId = "MN93UepDeWPJ2AeDBpuFluFne4EYoL2O5";

        // Create an execution request object.
        var request = {
            'function': 'doGet',
            'parameters': [getPlantName()],
            'devMode':true
            };

        // Make the API request.
        var op = gapi.client.request({
            'root': 'https://script.googleapis.com',
            'path': 'v1/scripts/' + scriptId + ':run',
            'method': 'POST',
            'body': request
        });

        op.execute(function(resp) {
          if (resp.error && resp.error.status) {
            // The API encountered a problem before the script
            // started executing.
            appendPre('Error calling API:');
            appendPre(JSON.stringify(resp, null, 2));
          } else if (resp.error) {
            // The API executed, but the script returned an error.

            // Extract the first (and only) set of error details.
            // The values of this object are the script's 'errorMessage' and
            // 'errorType', and an array of stack trace elements.
            var error = resp.error.details[0];
            appendPre('Script error message: ' + error.errorMessage);

            if (error.scriptStackTraceElements) {
              // There may not be a stacktrace if the script didn't start
              // executing.
              appendPre('Script error stacktrace:');
              for (var i = 0; i < error.scriptStackTraceElements.length; i++) {
                var trace = error.scriptStackTraceElements[i];
                appendPre('\t' + trace.function + ':' + trace.lineNumber);
              }
            }
          } else {
            // The structure of the result will depend upon what the Apps
            // Script function returns. Here, the function returns an Apps
            // Script Object with String keys and values, and so the result
            // is treated as a JavaScript object (folderSet).

            var files = resp.response.result;
            if (files && files.length > 0) {
              var file = files[0];
              appendFile(file);
            }
            else {
              appendPre('No files found.');
            }


          }
        });
      }

      /**
       * Append a pre element to the body containing the given message
       * as its text node.
       *
       * @param {string} message Text to be placed in pre element.
       */
      function appendPre(message) {
        var pre = document.getElementById('container');
        var textContent = document.createTextNode(message + '\n');
        pre.appendChild(textContent);
      }

      function appendFile(file){
        var pre = document.getElementById("reportList");
        var aTag = document.createElement('a');
        aTag.setAttribute('href', file.link);
        aTag.innerHTML = ("Informes de " + file.name + "\n");
        pre.appendChild(aTag);
      }

      function getLinkTitle(a){
        a = a.name.split(' ');
        var date = new Date(a[1] + ' 1 ' + a[2])
        var monthIndex = date.getMonth();
        var year = date.getFullYear();
        return plantName[a[0]] + ' ' + monthFullName[monthName[monthIndex]] + '-' + year;
      }  

      function nameToDate(a){
        a = a.name.split(' ');
        return new Date(a[1] + ' 1 ' + a[2]);
      } 

    </script>
    <script src="https://apis.google.com/js/client.js?onload=checkAuth">
    </script>  
    <h5 class="header col 12 light-blue-text center" id="reportList"></h5><br/>
    <div id="authorize-div" style="display: none">
      <span>Authorize access to Google Apps Script Execution API</span>
      <!--Button for the user to click to initiate auth sequence -->
      <button id="authorize-button" onclick="handleAuthClick(event)">
        Authorize
      </button>
    </div>
    <div class="container" id = "container">
    </div>
    <br/><br/>


    <div class="row center"><a id='sync-table' class="waves-effect waves-light btn">Sincronizar</a></div>
    <div class="row center" id="spinnerDestination"></div>
    <br/><br/>
    </div>
    <footer class="page-footer light-blue">
      <div class="container">
        <div class="row">
          <div class="col l6 s12">
            <h5 class="white-text">Quienes Somos: OpenSourceWater</h5>
            <p class="grey-text text-lighten-4">
              En el mundo hay miles de millones de personas quienes viven con agua contaminada y saneamiento inadecuado. Los proyectos de desarrollo que tienen como objetivo solucionar este problema generalmente son muy costosos, logran muy poco y no están siendo documentados. WASH4ALL está buscando mejorar el acceso universal al agua y saneamiento mediante herramientas que permitan mostrar y ubicar las necesidades, quienes y cómo están trabajando para solventarlas y donde se están alcanzando las metas.
            </p>
          </div>
        </div>
      </div>
      <div class="footer-copyright">
        <div class="container">
        Hecho por <a class="light-blue-text text-lighten-3" href="http://materializecss.com">Materialize</a>
        </div>
      </div>
    </footer>



  </body>
</html>
