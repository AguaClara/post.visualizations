<!DOCTYPE html>
<html lang="en">
  
  <head>
  <meta http-equiv="Content-Type" content="text/html; charset=UTF-8"/>
  <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1.0"/>
  <title>Wash4All</title>

  <!--  Scripts-->
  <script src="js/jquery-2.1.1.min.js"></script>
  <script src="js/materialize.js"></script>
  <script src="js/init.js"></script>
  <!--D3 -->
  <script src="js/d3.v3.min.js" charset="utf-8"></script>

  <!-- CSS  -->
  <link href="https://fonts.googleapis.com/icon?family=Material+Icons" rel="stylesheet">
  <link href="css/materialize.css" type="text/css" rel="stylesheet" media="screen,projection"/>
  <link href="css/style.css" type="text/css" rel="stylesheet" media="screen,projection"/>
  <link href="css/viz.css" type="text/css" rel="stylesheet" media="screen,projection"/>
</head>

<body>
  <nav class="light-blue lighten-1" role="navigation">
    <div class="nav-wrapper container"><a id="logo-container" href="./index.html" class="brand-logo">OpenSourceWater</a>
    </div>
  </nav>
  <div class="section no-pad-bot" id="index-banner">
    <div class="container">
      <br><br>
      <!--<h1 class="header center orange-text">Wash4All</h1>-->
      <div class="row center">
        <h4>Morocel√≠ Plant Data</h4>
        <h5 class="header col s12 light">Select the types of data you would like to see visualized.</h5>
      </div>
  <div id="headerContent"></div>
  <div class="container">

      <div class="row center"> 

      </div>
    </div>

        
  </div>

  <div class="container">
    <div class="section">
      <form action=".">
        <input type="checkbox" class="filled-in" id="raw_turb" name="dtype" value="raw_turb" checked/>
          <label for="raw_turb"><span class="checkboxtext">Raw turbidity</span></label><br/><br/>
        <input type="checkbox" class="filled-in" id="settled_turb" name="dtype" value="settled_turb"/>
          <label for="settled_turb"><span class="checkboxtext">Effluent turbidity</span></label><br/><br/>
        <input type="checkbox" class="filled-in" id="coagulant" name="dtype" value="coagulant"/>
          <label for="coagulant"><span class="checkboxtext">Coagulant dose</span></label><br/><br/>
        <input type="checkbox" class="filled-in" id="flow_rate" name="dtype" value="flow_rate"/>
          <label for="flow_rate"><span class="checkboxtext">Flow rate (L/s)</span></label><br/><br/>
      </form>

      <div id="visualizer"></div>
      <div id="plot"></div>

      <script>

      $(document).ready(function() {

       $(".filled-in").on("click", function() {
          var matches = [];
          $(".filled-in:checked").each(function() {
              matches.push(this.value);
          });

          console.log(matches);
          if (matches.length == 2){
            $(".filled-in").attr("disabled", true);
            matches.forEach(function(m){
              $("#"+m).attr("disabled", false);
            })
            
          }else if (matches.length < 2){
            $(".filled-in").attr("disabled", false);
          }

        });

      });

      

      var colors; 

      var plantCoords = [
        {"lat": 14.446363, "longi" : -87.265564, "name":"Agalteca", "code":"aga"},
        {"lat": 13.852931, "longi" : -86.685029, "name":"Alauca","code":"ala"},
        {"lat": 14.929551, "longi" : -88.490029, "name":"Atima", "code":"ati"},
        {"lat": 14.248744, "longi" : -87.412891, "name":"Cuatro Comunidades", "code":"ccom"},
        {"lat": 14.492795, "longi" : -87.977579, "name":"Jesus de Otoro", "code":"doto"},
        {"lat": 14.156052, "longi" : -88.036309, "name":"Marcala", "code":"mar1"},
        {"lat": 14.123442, "longi" : -86.869707, "name":"Moroceli", "code":"moro"},
        {"lat": 13.980974, "longi" : -86.623315, "name":"San Matias", "code":"smat"},
        {"lat": 15.000367, "longi" : -88.731957, "name":"San Nicolas", "code":"snic"},
        {"lat": 14.189934, "longi" : -87.331426, "name":"Tamara", "code":"tam"}
      ];
   
      //Hardcoded to just be Moroceli for now...
      var codeList = ["moro"]; //list of currently chosen plants (by code)
      var data;

      d3.json("past_data.json", function(error, rows){
        data =rows;

        /* Sort input data by date .............................................*/
        function sortByDateAscending(a, b) {
            // Dates will be cast to numbers automagically:
            return new Date(a.date_submitted) - new Date(b.date_submitted);
        }
        data = data.sort(sortByDateAscending);

        /* Nest and display data ...............................................*/
        
        //Sort array by plant
        var plantData = d3.nest()
          .key(function(d) { return d.code; })
          .entries(data);

        //Associative array
        var plantDataDict = {};
        plantData.forEach(function(plant){
          plantDataDict[plant.key] = plant.values;
        });

        //D3 Color Scale using 20 distinct colors
        //Get the 11 dimensions
        var dataFields = Object.keys(plantDataDict[Object.keys(plantDataDict)[0]][0]);
        dataFields.splice(0,0); //Assumes pid is first and gets rid of it
        colors = d3.scale.category10().domain( dataFields );

        /* Create plot .........................................................*/
        var height = 350;
        var width = 290;
        var plot_padding_right = 40;
        var plot_padding_left = 40;
        var plot_padding_bottom = 62;
        var plot_padding_top = 20;

        var svg = d3.select("#plot").append("svg")
          .attr("height", height)
          .attr("width", width);

        /* Create and draw axes ................................................*/
        var xScale; var yScale; var xAxis; var yAxis0;

        makeXScale = function(data){
          //Can take first and last because they are already sorted
          var xMin = new Date(data[0].date_submitted);
          var xMax = new Date(data[data.length -1].date_submitted);
          xScale = d3.time.scale()
            .domain([xMin, xMax])
            .range([plot_padding_left, width-plot_padding_right]);
          return xScale;
        }

        drawXAxis = function(xScale){
          var xAxis = d3.svg.axis()
            .scale(xScale)
            .orient("bottom");
            
          svg.append("g")
            .attr("class", "axis")
            .attr("transform", "translate("+0+", " + (height-plot_padding_bottom) + ")")
            .call(xAxis)
            .selectAll("text")  
              .style("text-anchor", "end")
              .attr("dx", "-.8em")
              .attr("dy", ".15em")
              .attr("transform", function(d) {
                  return "rotate(-65)" 
                  });
        }

        makeYScale = function(data, attr_name){
          var yScale = d3.scale.linear()
            .domain([0, d3.max(data, function (d) {return d[attr_name]; })])
            .range([height-plot_padding_bottom, plot_padding_top]);
          return yScale;
        }

        drawYAxis = function(yScale){
          var yAxis = d3.svg.axis().scale(yScale).orient("left");
          svg.append("g")
            .attr("class", "axis")
            .attr("transform", "translate(" + plot_padding_left + ", "+ 0+")")
            .call(yAxis);
        }

        drawSecondYAxis = function(yScale){
          var yAxis = d3.svg.axis().scale(yScale).orient("right");
          svg.append("g")
            .attr("class", "axis")
            .attr("transform", "translate(" + (width - plot_padding_right) + ", "+ 0+")")
            .call(yAxis);
        }

        /* Make the line graph .................................................*/
        function drawLines(data, xScale, yScale, attr_name, codeList){
          var lineGen = d3.svg.line()
            .x(function(d) {
                return xScale(new Date(d.date_submitted));
            })
            .y(function(d) {
                return yScale(d[attr_name]);
            })
            .defined(function(d) { 
              return !isNaN(d[attr_name]); 
            });  
    
          //Draw the line graph for each plant with code in codelist
          svg.selectAll("#linegraphline"+attr_name).remove();

          //Check if this code was selected in order to draw it
          plantCode = data[0].code;

          if ($.inArray(plantCode, codeList)>-1){
            svg.append('g').append("path")
              .attr('d', lineGen(data))
              .attr('stroke', function(){
                return colors(attr_name); 
              }) 
              .attr('stroke-width', 2)
              .attr('fill', 'none')
              .attr("id", "linegraphline"+attr_name);
          }
      }       

      /* code = 
       * selectedList = len 1 or 2 of checkboxes that have been checked
       */
      function drawPlot(code, selectedList){
        if (selectedList.length>=1){
          attr1 = selectedList[0];

          xScale = makeXScale(plantDataDict[code]);
          drawXAxis(xScale);
          
          yScale = makeYScale(plantDataDict[code], attr1);
          drawYAxis(yScale);
          drawLines(plantDataDict[code], xScale, yScale, attr1, codeList);
          
          //Double axes part of plot
          if (selectedList.length==2){
            attr2 = selectedList[1];
            yScale2 = makeYScale(plantDataDict[code], attr2);
            drawSecondYAxis(yScale2);
            drawLines(plantDataDict[code], xScale, yScale2, attr2, codeList);
          }
        }
      }
      
      drawPlot("moro", ["raw_turb", "settled_turb"]);
      
      //Wouldn't it be cool if they could sweep a vertical bar over the data and 
      //see what the exact values were?
       });
    

      
      </script>

    </div>
    <br><br>

    <div class="section">

    </div>
  </div>

  <footer class="page-footer light-blue">
    <div class="container">
      <div class="row">
        <div class="col l6 s12">
          <h5 class="white-text">About OpenSourceWater</h5>
          <p class="grey-text text-lighten-4">Billions of people make do with unsafe water and inadequate sanitation treatment; development projects that aim to fix this frequently cost too much, achieve too little, and leave little or no public record. WASH for All is tracking the path towards universal access to water and sanitation by mapping the world‚Äôs knowledge of where these needs are unmet, who is working to meet them, and how.</p>


        </div>
        
      </div>
    </div>
    <div class="footer-copyright">
      <div class="container">
      Made by <a class="light-blue-text text-lighten-3" href="http://materializecss.com">Materialize</a>
      </div>
    </div>
  </footer>



  </body>
</html>
