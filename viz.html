<!DOCTYPE html>
<html lang="en">
  <!--D3 -->
  <script src="http://d3js.org/d3.v3.min.js" charset="utf-8"></script>
  <script src="http://d3js.org/topojson.v1.min.js"></script> 
  <!--tooltip-->
  <script src="js/tip.js"></script>
  <script src="https://code.jquery.com/jquery-2.1.1.min.js"></script>
  <script> 
    $(function(){
      $("#headerContent").load("header.html"); 
    });
  </script> 
  <div id="headerContent"></div>
  <div class="container">

      <div class="row left">
        <h4>Data Visualization</h4>
      </div> 

      <div class="row center"> 

      </div>
    </div>

        
  </div>

  <div class="container">
    <div class="section">

      <div id="visualizer"></div>

      <script>
      var plantCoords = [
        {"lat": 14.446363, "longi" : -87.265564, "name":"Agalteca", "code":"aga"},
        {"lat": 13.852931, "longi" : -86.685029, "name":"Alauca","code":"ala"},
        {"lat": 14.929551, "longi" : -88.490029, "name":"Atima", "code":"ati"},
        {"lat": 14.248744, "longi" : -87.412891, "name":"Cuatro Comunidades", "code":"ccom"},
        {"lat": 14.492795, "longi" : -87.977579, "name":"Jesus de Otoro", "code":"doto"},
        {"lat": 14.156052, "longi" : -88.036309, "name":"Marcala", "code":"mar1"},
        {"lat": 14.123442, "longi" : -86.869707, "name":"Moroceli", "code":"moro"},
        {"lat": 13.980974, "longi" : -86.623315, "name":"San Matias", "code":"smat"},
        {"lat": 15.000367, "longi" : -88.731957, "name":"San Nicolas", "code":"snic"},
        {"lat": 14.189934, "longi" : -87.331426, "name":"Tamara", "code":"tam"}
      ];

        var MAP_HEIGHT = 400;
        var MAP_WIDTH = 700;

        //Colors for circle markers on map
        var selected = "blue";
        var unselected = "maroon";

        var mapSVG = d3.select("#visualizer").append("svg")
            .attr("height",MAP_HEIGHT)
            .attr("width", MAP_WIDTH)
            .style("margin", "0 auto");

        var g = mapSVG.append("g");
        //place projection within bounds of the svg element
        var projection = d3.geo.mercator().scale([5000]).translate([7900,1500]);
        var path = d3.geo.path().projection(projection);

        var coords; //will hold coordinate pairs in loop
        var paddingText = 17; //offset my label text below map pins

        //Create a tooltip which has this plant's name
        tipcreate = function(){
          var tip = d3.tip()
          .attr('class', 'd3-tip')
          .offset(function(d){if(d.lat>14.3){return [-25, 0];}else if(d.name=="Moroceli"){return [30,0];}else{return [25,0];}})
          .direction(function(d){
            if(d.lat<14.3){return 's';}else{return 'n';}
          })
          .html(function(d){if(d.name=="Jesus de Otoro"){return "Jesus<br/>&nbsp;&nbsp;&nbsp;de<br/>Otoro";}return d.name;});

          mapSVG.call(tip);
          return tip;
        } 

        //Each plant should have its own tooltip for multiselect
        var toolTipArray = new Array(); 
        plantCoords.forEach(function(d){toolTipArray[d.name] = tipcreate();});

        d3.json("world-50m.json", function(error, world){
          //create and color map
          var countries = topojson.feature(world, world.objects.countries).features;
          g.selectAll("path")
          .data(countries)
          .enter().append("path")
          .attr("d", path)
          .style("fill", function(country) {
              // The data in the JSON file does not contain country names, only ISO-3166 numeric ids.
              if (country.id === 340){ return "#E0E0EB"; } //Honduras
              else{ return "white"; } 
          })
          .style("stroke", "white");
        });

        var selectedList = []; //list of currently chosen plants

        var circles = mapSVG.selectAll("circle").data(plantCoords).enter().append("circle")
          .attr("cx", function(coord){coords = projection([coord.longi, coord.lat]); return coords[0];})
          .attr("cy", function(coord){coords = projection([coord.longi, coord.lat]); return coords[1];})
          .attr("r", 7)
          .attr("name", function(coord){return coord.name;})
          .attr("code", function(coord){return coord.code;})
          .style("fill", unselected);
                  
        circles.on("mouseover", function(d){
          toolTipArray[d.name].show(d);
        });

        circles.on("mouseout", function(d){
          if ($.inArray(this, selectedList)==-1){
            toolTipArray[d.name].hide(d);
          }
        });

        circles.on("click", function(d){
          //Add if we're selecting
          if ($.inArray(this, selectedList)==-1){
            selectedList.push(this);
          }else{ //Delete if we're unselecting
            var index = selectedList.indexOf(this);
            selectedList.splice(index, 1);
            d3.select(this).style("fill", unselected);
          }
          selectedList.forEach(function(d){
            d3.select(d).style("fill", selected); //update colors
          })

        })
      
      </script>

      <div id="plot"></div>

      <script> 
      var data;
      d3.json("past_data.json", function(error, rows){
        data =rows;

        function sortByDateAscending(a, b) {
            // Dates will be cast to numbers automagically:
            return new Date(a.date_submitted) - new Date(b.date_submitted);
        }
        data = data.sort(sortByDateAscending);

        var height = 500;
        var width = 900;
        var plot_padding = 40;

        var svg = d3.select("#plot").append("svg")
        .attr("height", height)
        .attr("width", width);

        //Can take first and last because they are already sorted
        var xMin = new Date(data[0].date_submitted);
        var xMax = new Date(data[data.length -1].date_submitted);
        var xScale = d3.time.scale()
          .domain([xMin, xMax])
          .range([plot_padding, width-plot_padding]);
        
        var yScale = d3.scale.linear()
          .domain([0, d3.max(data, function (d) {return d.raw_turb; })])
          .range([height-plot_padding, plot_padding]);

        var xAxis = d3.svg.axis().scale(xScale);
        svg.append("g")
          .attr("class", "axis")
          .attr("transform", "translate("+0+", " + (height-plot_padding) + ")")
          .call(xAxis);
          
        var yAxis = d3.svg.axis().scale(yScale).orient("left");
        svg.append("g")
          .attr("class", "axis")
          .attr("transform", "translate(" + plot_padding + ", "+ 0+")")
          .call(yAxis);

        //Sort array by plant
        var plantData = d3.nest()
          .key(function(d) { return d.code; })
          .entries(data);

        var lineGen = d3.svg.line()
        .x(function(d) {
            return xScale(new Date(d.date_submitted));
        })
        .y(function(d) {
            return yScale(d.raw_turb);
        })
        .defined(function(d) { return !isNaN(d.raw_turb) ; });;  //& d.code == "ati"

        //D3 Color Scale using 20 distinct colors
        var plantNames = [];
        plantData.forEach(
          function(d){plantNames.push(d.key);}
        );
        var colors = d3.scale.category20()
        .domain( plantNames );

        console.log(colors);
        //Draw the line graph for each plant
        plantData.forEach(function(plant){
          svg.append('g').append("path")
          .attr('d', lineGen(plant.values))
          .attr('stroke', function(){return colors(plant.key);}) //Color corresponding to plant code
          .attr('stroke-width', 2)
          .attr('fill', 'none');
        })
        
        // Code for making a linear regression.... not sure if we will use, but keeping anyway for now
        // ===============
        // function generateLinear(slope, intercept, noise) {
        //   var x = gaussian();
        //   var y = x * slope + intercept + noise * gaussian();
          
        //   return { x: x, y: y };
        // }

        // var points = [];

        // var circles = svg.selectAll("circle").data(points).enter()
        // .append("circle")
        // .attr("cx", function (d) { return xScale(d.x); })
        // .attr("cy", function (d) { return yScale(d.y); })
        // .attr("r", 2)
        // .style("opacity", "0.3");

        // Calculate the slope and intercept.
          
        // var model = {};

        // var meanX = d3.mean(points, function(d){return d.x;});
        // var meanY = d3.mean(points, function(d){return d.y;});

        // model.slope = d3.sum(points, function(d){
        //   return (d.x-meanX)*(d.y - meanY);
        // });
        // model.slope/= d3.sum(points, function(d){
        //   return (d.x - meanX)*(d.x - meanX);
        // });
          
        // model.intercept = meanY - model.slope * meanX;

        // var regressionLine = svg.append("line")
        // .attr("x1", xScale(-3))
        // .attr("y1", yScale(model.slope * -3 + model.intercept))
        // .attr("x2", xScale(3))
        // .attr("y2", yScale(model.slope * 3 + model.intercept))
        // .style("stroke", "#993333");
       });
      </script>

    </div>
    <br><br>

    <div class="section">

    </div>
  </div>

  <script> 
    $(function(){
      $("#footerContent").load("footer.html"); 
    });
  </script> 
  <div id="footerContent"></div>